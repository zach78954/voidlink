services:
  voidlink:
    image: gcr.dontfail.net/apps/voidlink:latest
    container_name: voidlink
    healthcheck:
      test: ["CMD-SHELL", "ip link show wg0 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    cap_add:
      - NET_ADMIN
    # devices:
    #   - /dev/net/tun:/dev/net/tun
    ports:
      - "51820:51820/udp"
    volumes:
      # Use a bind mount for the config file structure
      - ./config:/config
    environment:
      # Option 1: Direct Env Vars (Secrets)
      - WG_PRIVATE_KEY=${WG_PRIVATE_KEY}
      - WG_PRESHARED_KEY=${WG_PRESHARED_KEY}
      # - WG_PEER_PUBLIC_KEY=${WG_PEER_PUBLIC_KEY}

      # Option 2: File paths (useful for Docker Secrets)
      # - WG_PRIVATE_KEY_FILE=/run/secrets/wg_private_key
      # - WG_PRESHARED_KEY_FILE=/run/secrets/wg_preshared_key
    env_file:
      # Option 3: Load environment variables from a file
      - .env
    restart: unless-stopped
    sysctls:
      # NET_ADMIN capability usually handles internal stack, but enabling forwarding is critical.
      # In rootless Podman, this may be ignored or require specific host configuration.
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
